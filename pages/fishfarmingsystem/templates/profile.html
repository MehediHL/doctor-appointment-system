

{% extends 'base.html' %}

{% block title %}Profile{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
{% endblock %}

{% block content %}
<div class="AB">
    <!-- Profile Section -->
  <div class="newdiv">
    <div class="profile-card">
      <div class="avatar">
        <img id="avatarImg" src="/static/default_profile.png" alt="avatar">
        <label class="upload-overlay">
          <input type="file" id="photoInput" accept="image/*" hidden>
          <span>ðŸ“· Change</span>
        </label>
      </div>

      <div class="info">
        <h2 id="fullName">Your Name</h2>
        <p><b>Gmail:</b> <span id="gEmail"></span></p>
        <p><b>Phone:</b> <span id="gPhone"></span></p>
        <p><b>Location:</b> <span id="gLocation"></span></p>
      </div>

      <form id="editForm">
        <label>First name</label>
        <input type="text" name="first_name" placeholder="First name">

        <label>Last name</label>
        <input type="text" name="last_name" placeholder="Last name">

        <label>Old password</label>
        <input type="password" name="old_password" placeholder="Required to change password">

        <label>New password</label>
        <input type="password" name="new_password" placeholder="New password">
        
     <div class="button-row">
        <button type="submit" class="update-btn">Update Profile</button>
        <button type="button" id="logoutBtn" class="logout-btn">Logout</button>
     </div>
      </form>
    </div>
  </div>
  <!-- Scripts -->
  <script>
  async function loadProfile(){
    const res = await fetch('/get_profile');
    const j = await res.json();
    if(j.status !== 'ok'){ window.location.href = '/'; return; }
    const u = j.user;
    document.getElementById('fullName').innerText = u.first_name + ' ' + u.last_name;
    document.getElementById('gEmail').innerText = u.gmail;
    document.getElementById('gPhone').innerText = u.phone;
    document.getElementById('gLocation').innerText = u.location;
    if(u.photo) document.getElementById('avatarImg').src = u.photo;
  }
  loadProfile();

  // Update profile form
  document.getElementById('editForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/update_profile', { method:'POST', body: fd });
    const j = await res.json();
    document.getElementById('profileMsg').innerText = j.message || '';
    if(j.status === 'ok') loadProfile();
  });

  // Upload photo
  document.getElementById('photoInput').addEventListener('change', async function() {
    if (!this.files.length) return;
    const fd = new FormData();
    fd.append('photo', this.files[0]);
    const res = await fetch('/update_profile', { method:'POST', body: fd });
    const j = await res.json();
    document.getElementById('profileMsg').innerText = j.message || '';
    if (j.status === 'ok') loadProfile();
  });

  // Logout button
  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    await fetch('/logout', { method: 'POST' });
    window.location.href = '/';
  });
  </script>
</div>
{% endblock %}
