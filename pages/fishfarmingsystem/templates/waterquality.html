{% extends 'base.html' %}

{% block title %}Water Quality Monitoring{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
<link rel="stylesheet" href="{{ url_for('static', filename='waterquality.css') }}">

{% endblock %}

{% block content %}
<div class="body">
    
  <div class="container">
    <h2 class="text-center mb-4">ğŸŒŠ Live Water Quality Dashboard</h2>

    <div class="row">

      <!-- pH Card -->
      <div class="col-md-6 mb-3">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h5>pH Level</h5>
          </div>
          <div class="card-body">
            <div id="phDisplay" class="digital-box bg-secondary">--</div>
          </div>
        </div>
      </div>

      <!-- Temperature Card -->
      <div class="col-md-6 mb-3">
        <div class="card shadow">
          <div class="card-header bg-danger text-white">
            <h5>Water Temperature (Â°C)</h5>
          </div>
          <div class="card-body">
            <div id="tempDisplay" class="digital-box bg-secondary">--</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Charts -->
    <div class="row mt-4">
      <div class="col-md-6">
        <canvas id="phChart"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="tempChart"></canvas>
      </div>
    </div>

  </div>

<!-- Advice System -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card shadow">
      <div class="card-header bg-info text-white">
        <h5>ğŸŸ Expert Farming Advice</h5>
      </div>
      <div class="card-body">
        <div id="adviceBox" class="advice-box">
          Real-time fish farming advice will appear hereâ€¦
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Chart JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ================= FIREBASE CONFIG ===================
    var firebaseConfig = {
      apiKey: "AIzaSyC1dHqp3NPq0JO-U2ogJCd-55xppY4QX08",
      databaseURL: "https://phvalue-94291-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // ==================== CHART SETUP =====================
    let phChartCtx = document.getElementById("phChart").getContext("2d");
    let tempChartCtx = document.getElementById("tempChart").getContext("2d");

    let phChart = new Chart(phChartCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{ label: "pH Value", data: [] }]
      },
      options: { responsive: true }
    });

    let tempChart = new Chart(tempChartCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{ label: "Temperature (Â°C)", data: [] }]
      },
      options: { responsive: true }
    });

    // ================== UI COLOR HANDLER =================
    function updateDisplay(value, elementId, goodRange) {
      let box = document.getElementById(elementId);

      if (value === null || value === undefined) {
        box.innerHTML = "--";
        box.style.background = "gray";
        return;
      }

      box.innerHTML = value;

      if (value >= goodRange.min && value <= goodRange.max) {
        box.style.background = "green";
      } else {
        box.style.background = "red";
      }
    }

    // ================== REALTIME LISTENERS ================

    // 1ï¸âƒ£ pH Listener
    db.ref("/phSensor/value").on("value", snap => {
      let ph = snap.val();
      updateDisplay(ph, "phDisplay", { min: 6.5, max: 8.5 });

      phChart.data.labels.push("");
      phChart.data.datasets[0].data.push(ph);
      phChart.update();
    });

    // 2ï¸âƒ£ Temperature Listener
    db.ref("/phSensor/temperature").on("value", snap => {
      let temp = snap.val();
      updateDisplay(temp, "tempDisplay", { min: 20, max: 32 });

      tempChart.data.labels.push("");
      tempChart.data.datasets[0].data.push(temp);
      tempChart.update();
    });

  </script>

<script>

function updateAdvice(ph, temp) {
  const adviceBox = document.getElementById("adviceBox");
  adviceBox.innerHTML = "Generating AI advice...";
  adviceBox.style.opacity = 0.5;

  fetch("/get_advice", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ph: ph, temperature: temp })
  })
  .then(res => res.json())
  .then(data => {
    adviceBox.style.opacity = 1;
    adviceBox.innerHTML = data.advice;
  })
  .catch(err => {
    adviceBox.style.opacity = 1;
    adviceBox.innerHTML = "âš ï¸ Error generating advice.";
  });
}

let lastPH = null;
function shouldAskAdvice(newPH) {
  if (lastPH === null) {
    lastPH = newPH;
    return true;
  }
  if (Math.abs(newPH - lastPH) >= 0.4) {
    lastPH = newPH;
    return true;
  }
  return false;
}

// ===========================
// LISTEN FOR PH CHANGES
// ===========================
db.ref("/phSensor/value").on("value", snap => {
  let ph = snap.val();
  updateDisplay(ph, "phDisplay", { min: 6.5, max: 8.5 });

  phChart.data.labels.push("");
  phChart.data.datasets[0].data.push(ph);
  phChart.update();

  // ALSO GET LATEST TEMPERATURE
  db.ref("/phSensor/temperature").once("value", tSnap => {
    let temp = tSnap.val();

    // ğŸ”¥ Now trigger advice HERE
    if (shouldAskAdvice(ph)) {
      updateAdvice(ph, temp);
    }
  });
});

</script>
</div>
{% endblock %}

